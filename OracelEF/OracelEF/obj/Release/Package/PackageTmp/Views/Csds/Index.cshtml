@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>地理定位</title>
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no,email=no" name="format-detection" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
   
    <script language="javascript" src="http://webapi.amap.com/maps?v=1.3&key=6b91c8e7794066e50727187805153ee9"></script>
    <script src="~/Scripts/jquery-1.10.2.js" type="text/javascript"></script>
    <script type="text/javascript" src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="~/Scripts/base.js"></script>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
   
    <link href="~/Content/alipay/amui-demo_files/demo.css" rel="stylesheet" />
    <link href="~/Content/alipay/amui-demo_files/button-group.css" rel="stylesheet" />
    <link href="~/Content/alipay/amui-demo_files/message.css" rel="stylesheet" />
    <link href="~/Content/alipay/amui-demo_files/top-notice.css" rel="stylesheet" />
    <link href="~/Content/alipay/alipay.css" rel="stylesheet" />
    <link href="~/Content/alipay/amui-demo_files/amui.css" rel="stylesheet" />
    <link href="~/Content/zyUpload.css" rel="stylesheet" />
    <script src="~/Scripts/js/demo.js" type="text/javascript"></script>
    <script src="~/Scripts/js/zyFile.js" type="text/javascript"></script>
    <script src="~/Scripts/js/zyUpload.js" type="text/javascript"></script>
    <style>
        li {
            color:red;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="container">
            <div class="am-list am-list-5lb" am-mode="flat form">
                <div class="am-list-body">
                    <div class="am-list-item am-input-autoclear">
                        <div class="am-list-label">单位名称</div>
                        <div class="am-list-content">
                         <div id="UnitName">常熟市华贸商业有限公司</div>
                        </div>
                        <div class="am-list-clear"><i class="am-icon-clear am-icon" am-mode="clear"></i></div>
                    </div>
                    </div>
                @*<div class="am-list-body" style="margin-top:10px;">
                    <div class="am-list-item am-input-autoclear">
                        <div class="am-list-label">详细地址</div>
                        <div class="am-list-content">
                            <input type="text" placeholder="请输入单位详细地址" name="PCname" >
                        </div>
                        <div class="am-list-clear"><i class="am-icon-clear am-icon" am-mode="clear"></i></div>
                    </div>
                </div>*@
                <div class="am-list-body" style="margin-top:10px;">
                    <div class="am-list-item am-input-autoclear">
                        <div class="am-list-label">地图选点</div>
                        <div class="am-list-content">
                            <select>
                                <option>未选择</option>
                                <option>已选择</option>
                            </select>
                        </div>
                        <div class="am-list-arrow"><span class="am-icon" am-mode="arrow-horizontal"></span></div>

                    </div>
                </div>
                <div class="am-list-body" style="margin-top:10px;">
                    <div class="am-list-item am-input-autoclear">
                        <div class="am-list-label">自有或租赁</div>
                        <div class="am-list-content">
                            <input type="text" placeholder="" name="map" value="未选择">
                        </div>
                        <div class="am-list-arrow"><span class="am-icon" am-mode="arrow-horizontal"></span></div>

                    </div>
                </div>
                <div class="am-list-header">单位门脸照片</div>
                <div class="am-list-footer">
                    <ol>
                        <li>1.请确保单位名称清晰可见</li>
                        <li>2.需实际拍摄，勿上传设计图</li>
                    </ol>
                </div>
                <div class="am-flexbox" style="background-color:#fff">  
                    <div class="am-flexbox-item" style="height:120px;">
                        <img src="~/Images/lilai.jpg" style="width:120px;height:120px;float:right;padding-top:10px;padding-right:10px;" />
                        <canvas id="canvas"></canvas>
                    </div>
                    <div class="am-flexbox-item" style="height:140px;margin:0 auto">
                        <img src="~/Images/lilai.jpg" style="width:120px;height:120px;float:right;padding-top:10px;padding-right:10px;" />
                    </div>
                </div>
                     @*<div id="demo" class="demo"></div>*@
                <div class="am-list-header">温馨提示</div>
                <div class="am-list" am-mode="radius">
                    <div class="am-list-footer">
                        <ul>
                            <li style="color:gray">1.请确认单位名称与税务登记名称保持一致</li>
                            <li style="color:gray">2请确认地图选点准确定位到单位所在建筑范围内。</li>
                            <li style="color:gray">3.请务必保证联系电话准确畅通，我们将拨打此电话核实信息</li>
                        </ul>
                    </div>
                </div>
                <div style="padding-top:10px;">
                    <button type="submit" class="am-button" am-mode="blue">提交</button>
                </div>
            </div>
        </div>
    </div>

            @*<div class="container-fluid" style="margin-top:10px;">
                <div class="navbar navbar-fixed-top" style="z-index:99999; height:60px;">
                    <div class="container">
                        <div class="row">
                            <div class="alert alert-warning" style="padding:5px 15px;">
                                <div class="input-group" style="padding-top:10px;">
                                    <input type="text" class="form-control" id="address" placeholder="搜地点,辅助查询">
                                    <input id="real_lon" type="hidden" value="">
                                    <input id="real_lat" type="hidden" value="">
                                    <input id="location" type="hidden" value="" />
                                    <div class="input-group-btn">
                                        <button class="btn btn-default" type="button" onclick="geocoderlocation()">查询</button>
                                    </div>

                                </div>
                                <p class="list-group-item-text">请点击地图,用<img src="~/Images/mark_bs.png" style="width:15px;" />正确标注出<span id="cname" style="color:red"></span>所在位置</p>

                            </div>

                        </div>
                    </div>
                </div>
                <div id="iCenter"></div>
                <div class="navbar navbar-fixed-bottom">
                    <div class="alert alert-success" style="margin-bottom:0px;" id="sucess">
                        企业/单位名称：<span id="name" style="color:red;"></span>请确认标注位置准确无误之后，点击提交
                        <button type="button" class="btn btn-success btn-block" style="margin-top:10px;" onclick="AddLocation()">提交</button>
                    </div>
                </div>
            </div>*@
<script type="text/javascript">           
            /* 设定div宽度和高度 */
            $("#iCenter").width(window.innerWidth);
            $("#iCenter").height(window.innerHeight);
            var mapObj;
            var result;
            var marker = [];
            var windowsArr = [];
            function mapInit() {
                mapObj = new AMap.Map('iCenter');    //默认定位：初始化加载地图时，center及level属性缺省，地图默认显示用户所在城市范围
                mapObj.plugin(['AMap.Geolocation', 'AMap.Geocoder'], function () {
                    geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,//是否使用高精度定位，默认:true
                        timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                        maximumAge: 0,           //定位结果缓存0毫秒，默认：0
                        convert: false,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
                        showButton: false,        //显示定位按钮，默认：true
                        buttonPosition: 'RT',    //定位按钮停靠位置，默认：'LB'，左下角
                        buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                        showMarker: false,        //定位成功后在定位到的位置显示点标记，默认：true
                        showCircle: false,        //定位成功后用圆圈表示定位精度范围，默认：true
                        panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
                        zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                    });
                    geolocation.getCurrentPosition();
                    mapObj.addControl(geolocation);
                    AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
                    AMap.event.addListener(geolocation, 'error', onError);
                });
                var marker = new AMap.Marker({
                    position: mapObj.getCenter()
                });
                // marker.setMap(mapObj);
                var clickEventListener = AMap.event.addListener(mapObj, 'click', function (e) {
                    document.getElementById("real_lon").value = e.lnglat.getLng();
                    document.getElementById("real_lat").value = e.lnglat.getLat();
                    geocoder(e.lnglat.getLng(), e.lnglat.getLat())
                    mapObj.setCenter(new AMap.LngLat(e.lnglat.getLng(), e.lnglat.getLat()));
                    marker = new AMap.Marker({
                        position: new AMap.LngLat(e.lnglat.getLng(), e.lnglat.getLat())
                    });
                    mapObj.clearMap();//清除原有的标记
                    marker.setMap(mapObj);
                });
                function onError() {
                    alert("定位失败");
                }
                function onComplete(data) {
                    geocoder(data.position.getLng(), data.position.getLat());
                    document.getElementById("real_lon").value = data.position.getLng();
                    document.getElementById("real_lat").value = data.position.getLat();
                }
            };
            var MGeocoder;
            function geocoder(x, y) {
                var lnglatXY = new AMap.LngLat(x, y);
                mapObj.plugin(["AMap.Geocoder"], function () {
                    MGeocoder = new AMap.Geocoder({
                        radius: 1000,
                        extensions: "all"
                    });
                    AMap.event.addListener(MGeocoder, "complete", geocoder_CallBack);
                    MGeocoder.getAddress(lnglatXY);
                });
                var marker = new AMap.Marker({
                    map: mapObj,
                    icon: new AMap.Icon({
                        image: "http://api.amap.com/Public/images/js/mark.png",

                        size: new AMap.Size(28, 30),
                        imageOffset: new AMap.Pixel(-32, -0)
                    }),
                    position: lnglatXY,
                    offset: new AMap.Pixel(-5, -30)
                });
                mapObj.setFitView();
            }
            function geocoder_CallBack(data) { //回调函数
                // $("#address").val(data.regeocode.formattedAddress);
                $("#location").val(data.regeocode.formattedAddress);
            }
            function geocoderlocation() {
                mapObj.clearMap();
                var locationName = $("#address").val();
                var geocoder = new AMap.Geocoder({
                    city: "0512", //城市，默认：“全国”
                    radius: 1000 //范围，默认：500
                });
                geocoder.getLocation(locationName, function (status, result) {
                    if (status === 'complete' && result.info === 'OK') {
                        geocoder_CallBacklocation(result);
                    }
                });
            }
            function addMarker(i, d) {
                var marker = new AMap.Marker({
                    map: mapObj,
                    position: [d.location.getLng(), d.location.getLat()]
                });
                var infoWindow = new AMap.InfoWindow({
                    content: d.formattedAddress,
                    offset: { x: 0, y: -30 }
                });
                marker.on("mouseover", function (e) {
                    infoWindow.open(mapObj, marker.getPosition());
                });
            }
            function geocoder_CallBacklocation(data) {
                var geocode = data.geocodes;
                for (var i = 0; i < geocode.length; i++) {
                    $("#real_lon").val(geocode[0].location.getLng());
                    $("#real_lat").val(geocode[0].location.getLat());
                    $("#address").val(geocode[0].formattedAddress);
                    $("#location").val(geocode[0].formattedAddress);
                    addMarker(i, geocode[0]);
                }
                mapObj.setFitView();
            }
            function AddLocation() {
                var address = $("#location").val().trim();
                var CName = $("#name").html();
                if (address != "" && CName != "") {
                    var url = "../Csds/AddLocation";
                    $.ajax({
                        url: url,
                        data: {
                            real_lon: $("#real_lon").val(),
                            real_lat: $("#real_lat").val(),
                            address: $("#location").val(),
                            CName: $("#name").html(),
                            code: getQueryStringByName("code")
                        },
                        success: function (data) {
                            if (data.State == true) {

                                alert("数据采集成功");
                                location.href = "../Csds/Success";
                            }
                            else if (data.State == "exsit") {
                                var status = confirm("当前企业信息已经添加，是否更新？")
                                {
                                    if (status == true) {
                                        update();
                                    }
                                    else { return false; }
                                }
                            }
                            else { alert("数据添加失败,请重试！"); }
                        },
                        complete: function ()
                        { }
                    });
                }
                else {
                    if (address == "") {
                        alert("请先确定位置");
                        return false;
                    }

                    if (CName == "") {
                        alert("请输入企业名字");
                        return false;

                    }
                }
            }
            function update() {
                var url = "../Csds/UpdateLocation";
                $.ajax({
                    url: url,
                    data: {
                        real_lon: $("#real_lon").val(),
                        real_lat: $("#real_lat").val(),
                        address: $("#location").val(),
                        CName: $("#name").html(),
                        code: getQueryStringByName("code")
                    },
                    success: function (data) {
                        if (data.State == true) {
                            alert("数据更新成功");
                            location.href = "../Csds/Success";
                        }
                        else {
                            alert("数据更新失败,请重试！");
                        }
                    },
                    complete: function ()
                    { }
                });
            }
            //$(document).ready(function () {
            //    var code = getQueryStringByName("code");
            //    $.ajax({
            //        url: '../Csds/GetName',
            //        data: { code: code },
            //        success: function (data) {
            //            if (data != "" && data != null) {
            //                mapInit();
            //                $("#name").html(data);
            //                $("#cname").html(data);
            //            }
            //            else {
            //                location.href = "../Csds/Error";

            //            }
            //        },
            //        error: function () { },
            //    });
            //});
        </script>
</body>
</html>
