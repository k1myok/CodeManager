define(["dojo/_base/declare","esri/geometry/Point","esri/geometry/ScreenPoint","esri/SpatialReference","esri/geometry/webMercatorUtils","../common/Class","../common/WMapUtils","./Drawer"],function(e,t,a,r,i,s,n,o){return e("TrafficDrawer",[o],{constructor:function(){this.inherited(arguments),this.init()},init:function(){function e(){t(),requestAnimationFrame(e),d.render(n,o)}function t(){for(var e in a.roads){var t=a.roads[e];t.particles=t.particles||[];for(var r in t.particles){t.particles[r].position.x=t.particles[r].position.x+t._speed.x,t.particles[r].position.y=t.particles[r].position.y+t._speed.y;var i=!1,s=!1;t._speed.x>=0?t.particles[r].position.x>=t._end.x&&(i=!0):t.particles[r].position.x<=t._end.x&&(i=!0),t._speed.y>=0?t.particles[r].position.y>=t._end.y&&(s=!0):t.particles[r].position.y<=t._end.y&&(s=!0),i&&s&&(t.particles[r].position.x=t._start.x,t.particles[r].position.y=t._start.y)}}}var a=this;this.roads=[],this.roads=[{start:{x:12965318.12,y:4825216.47},end:{x:12964456.16,y:4825151.56},speed:5e3*Math.random()+1500},{start:{x:12964456.16,y:4825131.47},end:{x:12965318.12,y:4825197.53},speed:5e3*Math.random()+1500},{start:{x:12966199,y:4825292},end:{x:12965342.16,y:4825218.49},speed:5e3*Math.random()+1500},{start:{x:12965342.2,y:4825202.55},end:{x:12966206.16,y:4825266.53},speed:5e3*Math.random()+1500},{start:{x:12965318.2,y:4825196.55},end:{x:12965308.16,y:4824642.53},speed:5e3*Math.random()+1500},{start:{x:12965331.2,y:4824648.55},end:{x:12965340.16,y:4825202.53},speed:5e3*Math.random()+1500},{start:{x:12965341.2,y:4825219.55},end:{x:12965351.16,y:4825769.53},speed:5e3*Math.random()+1500},{start:{x:12965323.2,y:4825769.55},end:{x:12965319.16,y:4825217.53},speed:5e3*Math.random()+1500},{start:{x:12965355.2,y:4825769.55},end:{x:12966360.16,y:4825764.53},speed:5e3*Math.random()+1500},{start:{x:12966358.2,y:4825796.55},end:{x:12965353.16,y:4825802.53},speed:5e3*Math.random()+1500},{start:{x:12965320.2,y:4825798.55},end:{x:12964270.16,y:4825809.53},speed:5e3*Math.random()+1500},{start:{x:12964265.2,y:4825789.55},end:{x:12965324.16,y:4825767.53},speed:5e3*Math.random()+1500}];var r=window.canvas=this.getCtx().canvas,i=r.width,s=r.height,n=(r.parentElement,this.scene=new THREE.Scene),o=new THREE.OrthographicCamera(i/-2,i/2,s/2,s/-2,1,1e3),d=new THREE.WebGLRenderer({canvas:r,antialias:!0});d.setSize(r.width,r.height),o.position.z=150,e()},drawMap:function(){var e=this,t=(this.getLayer().getDataType(),this.getLayer().getData(),this.getCtx(),this.getDrawOptions(),this._map),a=t.extent.getCenter(),r=t.getZoom(),i=Math.pow(2,t.getMaxZoom()-r);this.endDrawMap();for(var s in this.roads){var n=this.roads[s];if(n.particles.length<1);else{for(var o in n.particles)this.scene.remove(n.particles[o]);n.particles=[]}var d=n._start={x:(n.start.x-a.x)/i,y:(n.start.y-a.y)/i},p=n._end={x:(n.end.x-a.x)/i,y:(n.end.y-a.y)/i},h=(n.distance=Math.sqrt(Math.pow(p.x-d.x,2)+Math.pow(p.y-d.y,2),2),p.x-d.x),y=p.y-d.y;n._speed={x:(p.x-d.x)/(n.speed/16),y:(p.y-d.y)/(n.speed/16)};for(var x=new THREE.SpriteMaterial({map:new THREE.CanvasTexture(e.generateSprite()),transparent:!0,opacity:1,blending:THREE.NoBlending}),s=0;10>s;s++){var c=new THREE.Sprite(x);c.position.set(d.x+s*h/10,d.y+s*y/10,0),c.scale.x=c.scale.y=30,this.scene.add(c),n.particles.push(c)}}},generateSprite:function(){var e=document.createElement("canvas");e.width=16,e.height=16;var t=e.getContext("2d"),a=t.createRadialGradient(e.width/2,e.height/2,0,e.width/2,e.height/2,e.width/2);return a.addColorStop(0,"rgba(255,255,255,1)"),a.addColorStop(.2,"rgba(255,255,0,0.8)"),a.addColorStop(.4,"rgba(64,64,0,0.4)"),a.addColorStop(.6,"rgba(64,64,0,0.2)"),a.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=a,t.fillRect(0,0,e.width,e.height),e}})});