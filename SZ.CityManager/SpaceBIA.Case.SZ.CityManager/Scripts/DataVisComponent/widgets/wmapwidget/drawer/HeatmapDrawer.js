define(["dojo/_base/declare","../common/Class","../common/WMapUtils","./Drawer"],function(t,a,i,e){return t("HeatmapDrawer",[e],{defaultRadius:10,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},constructor:function(){this.inherited(arguments),this.masker={},this._max=20,this._data=[];var t=this;i.extend(t,{})},getGradient:function(){return this.getDrawOptions().gradient||this.defaultGradient},getMax:function(){var t=this._max;if(void 0!==this.getDrawOptions().max)t=this.getDrawOptions().max;else{var a=this.getLayer().getDataRange();t=a.min+.7*(a.max-a.min)}return t},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t){var a=this._circle=document.createElement("canvas"),i=a.getContext("2d"),e=0;e=void 0!==this.getDrawOptions().shadowBlur?parseFloat(this.getDrawOptions().shadowBlur):0;var s=this._r=t+e;a.width=a.height="rect"===this.getDrawOptions().type?s:2*s;var r;if(void 0!==this.getDrawOptions().shadowBlur)i.shadowBlur=e,i.shadowColor="black",r=1e4;else{r=0;var h=i.createRadialGradient(s-r,s-r,0,s-r,s-r,t);h.addColorStop(0,"rgba(0, 0, 0, 1)"),h.addColorStop(1,"rgba(0, 0, 0, 0)"),i.fillStyle=h}return i.shadowOffsetX=i.shadowOffsetY=r,i.beginPath(),"rect"===this.getDrawOptions().type?i.fillRect(-r,-r,a.width,a.height):i.arc(s-r,s-r,t,0,2*Math.PI,!0),i.closePath(),i.fill(),this},drawHeatmap:function(t){this.radius(this.getRadius());var a=this.getCtx();a.save(),a.clearRect(0,0,this._width,this._height);var i=this.getLayer().getDataType(),e=this.getMax();if("polyline"===i){a.strokeStyle=this.getDrawOptions().strokeStyle||"rgba(0, 0, 0, 0.8)",a.lineWidth=this.getDrawOptions().lineWidth||1,a.beginPath();for(var s=0,r=this._data.length;r>s;s++){o=this._data[s];var h=o.pgeo;a.beginPath(),a.moveTo(h[0][0],h[0][1]);for(var n=1;n<h.length;n++)a.lineTo(h[n][0],h[n][1]);a.globalAlpha=Math.max(o.count/e,void 0===t?.05:t),a.stroke()}}else for(var o,d=this.getDrawOptions().boundary||this._circle.width+50,s=0,r=this._data.length;r>s;s++)o=this._data[s],o.px<-d||o.py<-d||o.px>a.canvas.width+d||o.py>a.canvas.height+d,a.globalAlpha=Math.max(o.count/e,void 0===t?.05:t),a.drawImage(this._circle,o.px-this._r,o.py-this._r);var g=a.getImageData(0,0,this._width,this._height);return this.colorize(g.data,this.dataRange.getGradient()),a.putImageData(g,0,0),a.restore(),this},colorize:function(t,a){var i=0,e=1024;this.masker.min&&(i=this.masker.min/this.getMax()*1024),this.masker.max&&(e=this.masker.max/this.getMax()*1024);for(var s,r=this.getDrawOptions().maxOpacity||.8,h=3,n=t.length;n>h;h+=4)s=4*t[h],t[h]/256>r&&(t[h]=256*r),s&&s>=i&&e>=s?(t[h-3]=a[s],t[h-2]=a[s+1],t[h-1]=a[s+2]):t[h]=0},drawMap:function(){var t=this;t.Scale&&t.Scale.set({min:0,max:t.getMax(),colors:this.getGradient()}),this.beginDrawMap();var a=this.getCtx();this._width=a.canvas.width,this._height=a.canvas.height;var i=this.getLayer().getData();this._data=i,this._width>0&&this._height>0&&this.drawHeatmap(),this.endDrawMap()},scale:function(t){var a=this;t.change(function(t,i){a.masker={min:t,max:i},a.drawMap()}),a.Scale=t}})});