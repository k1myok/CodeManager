define(["dojo/_base/declare","../common/Class","../common/WMapUtils","./Drawer"],function(e,t,a,r){return e("SimpleDrawer",[r],{constructor:function(){this.inherited(arguments)},drawMap:function(e){var t=this.getLayer().getDataType();if("webgl"===this.getLayer().getContext())return void("polyline"===t?this.drawWebglPolyline():this.drawWebglPoint());this.beginDrawMap();var r=this.getLayer().getData(),i=this.getCtx(),o=this.getDrawOptions();i.beginPath();var n=this.getRadius();if("polyline"===t){var l=o.label,s=this.getMap().getZoom(),h=Math.pow(2,18-s),g=(10+this.getDrawOptions().lineWidth)/h;if(l){l.font&&(i.font=l.font);var c=l.key||"count"}for(var f=this.getLayer().getAnimationOptions()||{},v=0,d=r.length;d>v;v++){var p=r[v].pgeo,m=0,u=p.length-1;if(e)for(var y=f.scope||10800,S=0;S<p.length&&(parseFloat(p[S][2])<e-y&&(m=S),u=S,!(parseFloat(p[S][2])>e));S++);if(!(m>=u)){i.beginPath(),i.lineWidth=this.getDrawOptions().lineWidth||1,i.moveTo(p[m][0],p[m][1]);for(var S=m+1;u>=S;S++)i.lineTo(p[S][0],p[S][1]);(o.strokeStyle||"polyline"===t)&&(i.stroke(),i.closePath()),i.beginPath(),i.moveTo(p[m][0],p[m][1]);var w=parseInt(h);w=Math.max(w,1),i.lineWidth=1;for(var S=m+1;u>=S;S+=w)if(o.arrow){i.save();var P=[p[S][0]-p[S-1][0],p[S-1][1]-p[S][1]],A=P[1],_=Math.sqrt(P[0]*P[0]+P[1]*P[1],2),b=A/_,R=Math.acos(b);if(P[0]<0&&(R=-R),R){g=Math.max(g,5);var x=[(p[S][0]-p[S-1][0])/2,(p[S][1]-p[S-1][1])/2];i.translate(p[S][0],p[S][1]),i.rotate(R),i.moveTo(g,g),i.lineTo(0,0),i.moveTo(-g,g),i.lineTo(0,0),i.translate(-p[S][0],-p[S][1]),i.moveTo(p[S][0],p[S][1])}i.restore()}if((o.strokeStyle||"polyline"===t)&&i.stroke(),l&&l.show&&(!l.minZoom||l.minZoom&&s>=l.minZoom)){i.save(),l.fillStyle&&(i.fillStyle=l.fillStyle);var x=(new a).getGeoCenter(p);i.fillText(r[v][c],x[0],x[1]),i.restore()}}}}else if("polygon"===t)for(var v=0,d=r.length;d>v;v++){var p=r[v].pgeo;if(!(p.length<=0)){i.beginPath(),i.moveTo(p[0][0],p[0][1]);for(var S=1;S<p.length;S++)i.lineTo(p[S][0],p[S][1]);i.closePath(),i.fill(),(o.strokeStyle||o.lineWidth)&&i.stroke()}}else{var F=o.icon;if(o.strokeStyle||o.globalCompositeOperation)for(var v=0,d=r.length;d>v;v++){var T=r[v];T.px<0||T.px>i.canvas.width||T.py<0||T>i.canvas.height||(i.beginPath(),F&&F.show&&F.url?this.drawIcon(i,T,F):(i.arc(T.px,T.py,n,0,2*Math.PI,!1),i.fill()),o.strokeStyle&&i.stroke())}else{for(var v=0,d=r.length;d>v;v++){var T=r[v];T.px<0||T.px>i.canvas.width||T.py<0||T>i.canvas.height||(i.moveTo(T.px,T.py),F&&F.show&&F.url?this.drawIcon(i,T,F):2>n?i.fillRect(T.px,T.py,2*n,2*n):i.arc(T.px,T.py,n,0,2*Math.PI,!1))}i.fill()}}this.endDrawMap()},drawIcon:function(e,t,r){var i=new Image,o=r.sx||0,n=r.sy||0,l=r.px||0,s=r.py||0,h=r.swidth||0,g=r.sheight||0,c=r.width||0,f=r.height||0;!function(t,r,o,n,h,g,c){i.onload=function(){var f=(new a).getPixelRatio(e);e.save(),e.scale(f,f),e.drawImage(i,r,o,n,h,t.px-g/2-l,t.py-c/2-s,g,c),e.restore()}}(t,o,n,h,g,c,f),i.src=r.url},drawAnimation:function(){var e=this.getLayer(),t=e.getData(),r=e.getDataType(),i=e.getAnimationOptions(),o=e.getAnimation(),n=e.getAnimationCtx();if("polyline"===r)if("time"===o);else for(var l=i.step||1,s=i.size||1,h=0,g=t.length;g>h;h+=l){var c=t[h].index,f=t[h].pgeo,v=(new a).getPixelRatio(n);n.save(),n.scale(v,v);var d=f[c][0],p=f[c][1],m=n.createRadialGradient(d,p,0,d,p,s);m.addColorStop(0,"rgba(255, 255, 255, 1)"),m.addColorStop(.4,"rgba(255, 255, 255, 0.9)"),m.addColorStop(1,"rgba(255, 255, 255, 0)"),n.fillStyle=i.fillStyle||m,n.beginPath(),n.arc(d,p,s,0,2*Math.PI,!1),n.closePath(),n.fill(),t[h].index++,t[h].index>=t[h].pgeo.length&&(t[h].index=0),n.restore()}},drawWebglPoint:function(){var e=this.getLayer().getData();if(e){var t,a,r,i,o=this.getCtx();t=o.createShader(o.VERTEX_SHADER),a=o.createShader(o.FRAGMENT_SHADER),r=["attribute vec4 a_Position;","attribute float a_PointSize;","void main() {","gl_Position = a_Position;","gl_PointSize = a_PointSize;","}"].join(""),i=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var n=o.createProgram();o.shaderSource(t,r),o.compileShader(t),o.shaderSource(a,i),o.compileShader(a),o.attachShader(n,t),o.attachShader(n,a),o.linkProgram(n),o.useProgram(n);var l=o.getAttribLocation(n,"a_Position"),s=o.getAttribLocation(n,"a_PointSize"),h=o.getUniformLocation(n,"u_FragColor");o.clear(o.COLOR_BUFFER_BIT);for(var g=o.canvas.width/2,c=o.canvas.height/2,f=[],v=0,d=0;d<e.length;d++){var p=e[d],m=(p.px-g)/g,u=(c-p.py)/c;-1>m||m>1||-1>u||u>1||(f.push(m,u),v++)}var y=new Float32Array(f),S=v,w=o.createBuffer();if(!w)return-1;o.bindBuffer(o.ARRAY_BUFFER,w),o.bufferData(o.ARRAY_BUFFER,y,o.STATIC_DRAW),o.vertexAttribPointer(l,2,o.FLOAT,!1,0,0),o.enableVertexAttribArray(l),o.vertexAttrib1f(s,this.getRadius());var P=document.createElement("canvas"),A=P.getContext("2d");P.width=1,P.height=1,A.fillStyle=this.getDrawOptions().fillStyle,A.fillRect(0,0,1,1);var _=A.getImageData(0,0,1,1).data;o.uniform4f(h,_[0]/255,_[1]/255,_[2]/255,_[3]/255),o.drawArrays(o.POINTS,0,S)}},drawWebglPolyline:function(){var e=this.getLayer().getData();if(e){var t,a,r,i,o=this.getCtx();t=o.createShader(o.VERTEX_SHADER),a=o.createShader(o.FRAGMENT_SHADER),r=["attribute vec4 a_Position;","void main() {","gl_Position = a_Position;","gl_PointSize = 30.0;","}"].join(""),i=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var n=o.createProgram();o.shaderSource(t,r),o.compileShader(t),o.shaderSource(a,i),o.compileShader(a),o.attachShader(n,t),o.attachShader(n,a),o.linkProgram(n),o.useProgram(n),o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE),o.clear(o.COLOR_BUFFER_BIT);var l=o.canvas.width/2,s=o.canvas.height/2,h=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,h);var g=o.getAttribLocation(n,"a_Position");o.vertexAttribPointer(g,2,o.FLOAT,!1,0,0),o.enableVertexAttribArray(g);var c=o.getUniformLocation(n,"u_FragColor"),f=document.createElement("canvas"),v=f.getContext("2d");f.width=1,f.height=1,v.fillStyle=this.getDrawOptions().strokeStyle||"red",v.fillRect(0,0,1,1);var d=v.getImageData(0,0,1,1).data;o.uniform4f(c,d[0]/255,d[1]/255,d[2]/255,d[3]/255),o.lineWidth(this.getDrawOptions().lineWidth||1);for(var p=0,m=e.length;m>p;p++){for(var u=e[p].pgeo,y=[],S=0;S<u.length;S++){var w=u[S],P=(w[0]-l)/l,A=(s-w[1])/s;y.push(P,A)}var _=new Float32Array(y);o.bufferData(o.ARRAY_BUFFER,_,o.STATIC_DRAW),o.drawArrays(o.LINE_STRIP,0,u.length)}}}})});