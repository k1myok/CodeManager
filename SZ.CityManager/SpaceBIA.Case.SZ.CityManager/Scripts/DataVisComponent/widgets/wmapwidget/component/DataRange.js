define(["dojo/_base/declare","../common/Class","../common/WMapUtils","../common/MVCObject"],function(t,i,a,e){return t("DataRange",[e],{defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},colors:["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],constructor:function(t){this.initOptions({min:0,max:0}),this.set("layer",t),this.bindTo("data",t),this.bindTo("drawOptions",t),this.bindTo("drawType",t);var i=this,e=new a;e.extend(i,{})},getSize:function(t){for(var i=1,a=this.splitList,e=0;e<a.length;e++)if((void 0===a[e].start||void 0!==a[e].start&&t>=a[e].start)&&(void 0===a[e].end||void 0!==a[e].end&&t<a[e].end)){i=a[e].size;break}return i},getColorByRange:function(t){for(var i="rgba(50, 50, 255, 1)",a=this.splitList,e=0;e<a.length;e++)if((void 0===a[e].start||void 0!==a[e].start&&t>=a[e].start)&&(void 0===a[e].end||void 0!==a[e].end&&t<a[e].end)){i=a[e].color;break}return i},data_changed:function(){var t=this,i=t.get("data");if(i&&i.length>0){t._min=i[0].count,t._max=i[0].count;for(var a=0;a<i.length;a++)t._max=Math.max(t._max,i[a].count),t._min=Math.min(t._min,i[a].count)}},drawType_changed:function(){this.update()},drawOptions_changed:function(){this.update()},update:function(){var t=this.get("drawOptions");t&&t.splitList?this.splitList=t.splitList:this.generalSplitList(),"category"===this.get("layer").getDrawType()&&(t&&t.splitList?this.categorySplitList=t.splitList:this.generalCategorySplitList()),("heatmap"===this.get("layer").getDrawType()||"density"===this.get("layer").getDrawType()||"intensity"===this.get("layer").getDrawType())&&this.generalGradient(t.gradient||this.defaultGradient),this.draw()},draw:function(){this.get("layer").getDataRangeControl()&&this.get("layer").dataRangeControl.show(),"bubble"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawSizeSplit(this.splitList,this.get("drawOptions")):"category"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawCategorySplit(this.categorySplitList,this.get("drawOptions")):"choropleth"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawChoroplethSplit(this.splitList,this.get("drawOptions")):this.get("layer").dataRangeControl.hide()},generalSplitList:function(){var t=Math.ceil((this._max-this._min)/7),i=this._min;this.splitList=[];for(var a=1;i<this._max;)this.splitList.push({start:i,end:i+t,size:a,color:this.colors[a-1]}),i+=t,a++},generalCategorySplitList:function(){var t=["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)"],i=this.get("data");this.categorySplitList={};for(var a=0,e=0;e<i.length&&(void 0===this.categorySplitList[i[e].count]&&(this.categorySplitList[i[e].count]=t[a],a++),!(a>=t.length-1));e++);this.categorySplitList.other=t[t.length-1]},getCategoryColor:function(t){var i=this.categorySplitList,a=i.other;for(var e in i)if(t==e){a=i[e];break}return a},generalGradient:function(t){var i=document.createElement("canvas"),a=i.getContext("2d"),e=a.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var r in t)e.addColorStop(r,t[r]);a.fillStyle=e,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data},getGradient:function(){return this._grad},getColorByGradient:function(t){var i=this.get("max")||10,a=t/i;a>1&&(a=1),a*=255,a=parseInt(a,10),a*=4;var e="rgba("+this._grad[a]+", "+this._grad[a+1]+", "+this._grad[a+2]+","+this._grad[a+3]/255+")";return e}})});