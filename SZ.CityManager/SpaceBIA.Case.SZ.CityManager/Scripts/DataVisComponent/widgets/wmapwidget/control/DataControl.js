define(["dojo/_base/declare"],function(e){return e("DataControl",null,{constructor:function(e){this.initDom(),this.initEvent(),this.super=e,this.geoData=e.geoData},initDom:function(){var e=this.control=document.createElement("div"),t=this.input=document.createElement("input");t.type="file";var i=document.createElement("div");i.textContent="自定义数据：";var n=document.createElement("div");n.textContent="拖拽文件到窗口或者选择自定义文件",e.appendChild(i),e.appendChild(n),e.appendChild(t),e.style.fontSize="12px",e.style.lineHeight="1.8em",e.style.position="absolute",e.style.bottom="50px",e.style.left="10px",e.style.padding="10px 20px",e.style.color="#FFF",e.style.background="rgba(0,0,0,0.5)",e.style.zIndex="100000",e.style.overflow="hidden",e.style.webkitTransition="all 0.5s ease-in";var a=document.createElement("div"),r=document.createElement("div");r.textContent="历史数据",this.history=document.createElement("div"),a.appendChild(r),a.appendChild(this.history),e.appendChild(a),document.body.appendChild(e)},initEvent:function(){function e(e){var i,n=!1;try{i=JSON.parse(e.replace(/\s/g,""));for(var a=0;"string"==typeof i&&10>=a;)i=JSON.parse(i),a++;n=!1}catch(r){n=!0}if(n)try{i=[];var l=e.split("\n");l.length<=1&&(l=e.split("\\n"));for(var s=l[0].split(","),o=1;o<s.length;o++){for(var d=l[o].split(","),f={},c=0,p=0;p<d.length;p++){var u=s[p]||"noname"+c++;u=u.replace(/\\r/g,""),f[u]=Number(d[p].replace(/\\r/g,"").replace(/\"/g,""))}i.push(f)}i=JSON.stringify(i).replace(/\\r/g,""),i=JSON.parse(i),n=!1}catch(r){n=!0}if(n)return alert("数据格式错误，请检查是否为json或者csv格式数据"),!1;t.geoData.setData(i);for(var o=0;o<t.super._layers.length;o++)t.super._layers[o].draw();return!0}var t=this,i=new FileReader;i.addEventListener("load",function(){var n=i.result,a=e(n);if(a){var r=localStorage.getItem("filenames")||"{}";if(r=JSON.parse(r),!i.fileName||!i.fileSize)return!1;for(var l in r)if(r[l].name===this.fileName&&r[l].size===this.fileSize)return!1;var s=this.fileName+this.fileSize+parseInt(1e17*Math.random(),10).toString(36);r[s]={size:this.fileSize,name:this.fileName},localStorage.setItem("filenames",JSON.stringify(r)),localStorage.setItem(s,JSON.stringify(n)),t.initHistory()}}),t.history.addEventListener("click",function(t){var i=t.target;if("A"===i.nodeName){var n=i.getAttribute("storageName"),a=localStorage.getItem(n);e(a)}return!1}),t.input.addEventListener("change",function(e){i.readAsText(e.target.files[0]),i.fileName=e.target.files[0].name,i.fileSize=e.target.files[0].size}),document.addEventListener("dragover",function(e){e.preventDefault()},!1),document.addEventListener("drop",function(e){return e.preventDefault(),i.readAsText(e.dataTransfer.files[0]),i.fileName=e.dataTransfer.files[0].name,i.fileSize=e.dataTransfer.files[0].size,!1})}})});